name: Deploy Frontend to Specific Path

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node & pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install Dependencies & Build (In Runner Temp)
        run: |
          pnpm install --frozen-lockfile
          pnpm run build

      - name: Deploy to Target Path
        shell: powershell
        run: |
          # 1. กำหนดตัวแปร Path (ใส่ฟันหนูเพราะมีช่องว่าง Web Project)
          $TargetDir = "C:\Users\Administrator\Desktop\Web Project\KU-run\KU-RUN-Check-in-Frontend"

          # 2. สร้างโฟลเดอร์ปลายทางถ้ายังไม่มี
          if (!(Test-Path $TargetDir)) { New-Item -ItemType Directory -Force -Path $TargetDir }

          # 3. Copy ไฟล์ที่จำเป็นไปที่ปลายทาง (Build, Package.json)
          # ใช้ Copy-Item หรือ Robocopy
          Write-Host "Copying files to $TargetDir..."
          Copy-Item -Path ".\build" -Destination "$TargetDir\build" -Recurse -Force
          Copy-Item -Path ".\package.json" -Destination $TargetDir -Force
          Copy-Item -Path ".\pnpm-lock.yaml" -Destination $TargetDir -Force
          # Copy-Item -Path ".\.env" -Destination $TargetDir -Force # (ถ้าต้องการ Copy .env ด้วย)

      - name: Install Prod Deps & Restart (At Target Path)
        shell: powershell
        run: |
          $TargetDir = "C:\Users\Administrator\Desktop\Web Project\KU-run\KU-RUN-Check-in-Frontend"
          
          # ย้ายการทำงานไปที่โฟลเดอร์ปลายทาง
          Set-Location $TargetDir
          
          # ลงเฉพาะ Production dependencies (เบากว่า)
          pnpm install --prod

          # Restart PM2 จาก Path นี้
          # ใช้ --update-env เพื่อให้แน่ใจว่าค่า config ใหม่ถูกโหลด
          pm2 start build/index.js --name "ku-run-frontend" --update-env --force
          pm2 save
          