name: Deploy Frontend to Windows VPS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code (Trigger)
        uses: actions/checkout@v4
        with:
          clean: false 

      - name: Deploy Frontend Script
        shell: powershell
        run: |
          # ================= CONFIG =================
   
          $PROJECT_PATH = "C:\Users\Administrator\Desktop\Web Project\KU-run\KU-RUN-Check-in-Frontend"
          $PM2_NAME = "ku-run-frontend"
          # ==========================================

          Write-Host "Starting Frontend Deployment to $PROJECT_PATH..."

          if (Test-Path $PROJECT_PATH) {
              cd $PROJECT_PATH
          } else {
              Write-Error "Project Path not found: $PROJECT_PATH"
              exit 1
          }

          Write-Host "Pulling latest code..."
          git fetch origin master
          

          git reset --hard origin/master

          Write-Host "Restarting PM2 Service..."
          
          # ใช้ describe เช็คก่อนว่ามี process นี้ไหม (ส่ง output ลงถังขยะ $null)
          pm2 describe $PM2_NAME | Out-Null
          
          if ($LASTEXITCODE -eq 0) {
              # ถ้ามีอยู่แล้ว ให้ Restart
              Write-Host "Process found. Restarting..."
              pm2 restart $PM2_NAME --update-env
          } else {
              # ถ้าไม่มี ให้ Start ใหม่
              Write-Host "Process not found. Starting new..."
              pm2 start build/index.js --name $PM2_NAME
          }
          
          # Save สถานะ
          pm2 save

          Write-Host "Frontend Deployment Complete!"