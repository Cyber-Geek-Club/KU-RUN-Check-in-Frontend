name: Deploy Frontend to Windows VPS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Deploy Script
        shell: powershell
        run: |
          # ================= CONFIG =================
          $PROJECT_PATH = "C:\Users\Administrator\Desktop\Web Project\KU-run\KU-RUN-Check-in-Frontend"
          $PM2_NAME = "ku-run-frontend"

          # App Network Config
          $APP_HOST = "0.0.0.0"
          $APP_PORT = "3000"
          # ==========================================

          Write-Host "========================================"
          Write-Host "  KU-RUN Frontend Deployment (SvelteKit)"
          Write-Host "========================================"

          # 1. Enter project directory
          if (Test-Path $PROJECT_PATH) {
              Set-Location $PROJECT_PATH
          } else {
              Write-Error "Project path not found: $PROJECT_PATH"
              exit 1
          }

          # 2. Update source code
          Write-Host "Pulling latest code..."
          git fetch origin master
          git reset --hard origin/master

          # 3. Install dependencies
          Write-Host "Installing dependencies..."
          pnpm install --frozen-lockfile

          # 4. Build SvelteKit
          Write-Host "Building SvelteKit project..."
          pnpm run build

          # 5. PM2 process handling
          Write-Host "Configuring PM2..."

          pm2 describe $PM2_NAME | Out-Null
          if ($LASTEXITCODE -eq 0) {
              Write-Host "Existing PM2 process found. Deleting..."
              pm2 delete $PM2_NAME
          }

          # 6. Set environment variables
          $env:HOST = $APP_HOST
          $env:PORT = $APP_PORT
          $env:NODE_ENV = "production"

          Write-Host "Starting SvelteKit on ${APP_HOST}:${APP_PORT}..."

          # ‚ö†Ô∏è IMPORTANT: SvelteKit ‡∏ï‡πâ‡∏≠‡∏á start ‡∏î‡πâ‡∏ß‡∏¢ directory (build)
          pm2 start build `
            --name $PM2_NAME `
            --interpreter node `
            --ignore-watch="node_modules"

          # 7. Save PM2 state
          pm2 save

          Write-Host "========================================"
          Write-Host " Frontend Deployment Completed Successfully üöÄ"
          Write-Host "========================================"
