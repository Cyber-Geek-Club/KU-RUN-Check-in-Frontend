name: Deploy Frontend to Windows VPS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: false 

      - name: Deploy Script
        shell: powershell
        run: |
          # ================= CONFIG =================
          $PROJECT_PATH = "C:\Users\Administrator\Desktop\Web Project\KU-run\KU-RUN-Check-in-Frontend"
          $PM2_NAME = "ku-run-frontend"
          $PORT = 3000  # กำหนด Port ที่ต้องการรัน
          $ORIGIN = "http://localhost:3000" # <-- แก้เป็นโดเมนจริงของคุณ เช่น https://ku-run.com
          # ==========================================

          Write-Host "Starting Deployment to $PROJECT_PATH..."

          # 1. Navigate to project directory
          if (Test-Path $PROJECT_PATH) {
              Set-Location $PROJECT_PATH
          } else {
              Write-Error "Project Path not found: $PROJECT_PATH"
              exit 1
          }

          # 2. Pull & Reset Code
          Write-Host "Pulling latest code..."
          git fetch origin master
          git reset --hard origin/master

          # 3. Install & Build
          Write-Host "Installing dependencies & Building..."
          pnpm install --frozen-lockfile
          pnpm run build

          # 4. Manage PM2 Process
          Write-Host "Configuring PM2..."
          
          # Check if process exists and delete it to ensure clean env vars
          pm2 describe $PM2_NAME | Out-Null
          if ($LASTEXITCODE -eq 0) {
              Write-Host "Process found. Deleting to apply new config..."
              pm2 delete $PM2_NAME
          }

          # START command for SvelteKit (adapter-node)
          # Note: Passing Environment Variables for SvelteKit
          Write-Host "Starting process..."
          
          # ใช้ --env เพื่อส่งค่า PORT, ORIGIN, NODE_ENV เข้าไป
          # build/index.js คือไฟล์ที่ adapter-node สร้างขึ้น
          pm2 start "build/index.js" --name "$PM2_NAME" --watch --ignore-watch="node_modules .git .svelte-kit" --env PORT=$PORT,ORIGIN=$ORIGIN,NODE_ENV=production
          
          # Save PM2 state
          pm2 save

          Write-Host "Deployment Complete!"