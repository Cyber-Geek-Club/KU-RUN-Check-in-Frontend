import{w as A}from"./BuN0ijjp.js";const E="http://158.108.102.14:8001";function S(r){return Date.now()+r*1e3}function g(r){return r?Date.now()>=r-6e4:!0}function U(){let r=null,p=null,c=null,a=null;{r=localStorage.getItem("access_token"),p=localStorage.getItem("refresh_token");const e=localStorage.getItem("token_expiry");c=e?parseInt(e):null;const t=localStorage.getItem("user_info");if(t)try{a=JSON.parse(t)}catch(o){console.error("Failed to parse user info:",o)}r&&g(c)&&(console.log("Token expired on load"),r=null,a=null,localStorage.removeItem("access_token"),localStorage.removeItem("token_expiry"))}const{subscribe:_,set:u,update:y}=A({token:r,refreshToken:p,tokenExpiry:c,isAuthenticated:!!r,user:a});let s=null;function h(e){s&&clearTimeout(s);const t=e-Date.now()-12e4;t>0&&(s=setTimeout(()=>{console.log("Auto-refreshing token..."),f()},t))}async function f(){const e=localStorage.getItem("refresh_token");if(!e)return console.error("No refresh token available"),k(),!1;try{const t=await fetch(`${E}/api/users/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!t.ok)throw new Error("Token refresh failed");const o=await t.json(),i=o.access_token,n=S(o.expires_in||3600);return localStorage.setItem("access_token",i),localStorage.setItem("token_expiry",n.toString()),o.refresh_token&&localStorage.setItem("refresh_token",o.refresh_token),y(l=>({...l,token:i,tokenExpiry:n,refreshToken:o.refresh_token||l.refreshToken})),h(n),console.log("Token refreshed successfully"),!0}catch(t){return console.error("Token refresh error:",t),k(),!1}}function d(e){if(!e.access_token){console.error("Login error: Missing access token");return}const t=e.access_token,o=e.refresh_token||null,i=e.expires_in||3600,n=S(i),l={id:e.user_id||0,email:e.email||"",name:e.name||"",role:e.role||""};localStorage.setItem("access_token",t),localStorage.setItem("token_expiry",n.toString()),localStorage.setItem("user_info",JSON.stringify(l)),o&&localStorage.setItem("refresh_token",o),u({token:t,refreshToken:o,tokenExpiry:n,isAuthenticated:!0,user:l}),h(n)}function m(){localStorage.clear(),sessionStorage.clear(),document.cookie.split(";").forEach(e=>{document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")})}function k(){s&&(clearTimeout(s),s=null),m(),u({token:null,refreshToken:null,tokenExpiry:null,isAuthenticated:!1,user:null})}function x(){console.log("ðŸš¨ Force logout due to error - clearing all storage"),m(),u({token:null,refreshToken:null,tokenExpiry:null,isAuthenticated:!1,user:null}),typeof window<"u"&&(window.location.href="/auth/login")}function T(){const e=localStorage.getItem("access_token"),t=localStorage.getItem("token_expiry");if(!e||!t)return!1;const o=parseInt(t);return g(o)?(console.log("Token expired, attempting refresh..."),f(),!1):!0}function I(){const e=localStorage.getItem("user_info");if(e)try{return JSON.parse(e)}catch(t){return console.error("Failed to parse user info:",t),null}return null}function w(){const e=localStorage.getItem("access_token"),t=localStorage.getItem("token_expiry");if(!e||!t)return!1;const o=parseInt(t);return!g(o)}return{subscribe:_,login:d,logout:k,refreshAccessToken:f,checkTokenValidity:T,getUser:I,isAuthenticated:w,forceLogoutAndRedirect:x}}const N=U();export{N as a};
